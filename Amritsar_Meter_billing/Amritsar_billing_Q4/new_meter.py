import requests
import json
import psycopg2
import os
import datetime
import time

# --------------------------------------------
# Configuration: Select MDMS Billing Period
# --------------------------------------------
MDMS_PERIODS = {
    "WS-2024-25-Q3": {
        "fromDate": 1727740800000,  # 01/10/2024
        "toDate": 1735669799000     # 31/12/2024
    },
    "WS-2024-25-Q4": {
        "fromDate": 1735689600000,
        "toDate": 1743445799000
    },
    "WS-2025-26-Q1": {
        "fromDate": 1743465600000,
        "toDate": 1751308199000
    },
    "WS-2025-26-Q2": {
        "fromDate": 1751328000000,
        "toDate": 1759256999000
    }
}

# Select period to bill
SELECTED_CODE = "WS-2024-25-Q4"
selected_period = MDMS_PERIODS[SELECTED_CODE]

prev_date_epoch = selected_period["fromDate"]
current_date_epoch = selected_period["toDate"]

prev_date = datetime.datetime.fromtimestamp(prev_date_epoch / 1000).strftime("%d/%m/%Y")
current_date = datetime.datetime.fromtimestamp(current_date_epoch / 1000).strftime("%d/%m/%Y")
billingPeriod = prev_date + "-" + current_date

print(f"üßæ Selected Billing Period: {billingPeriod} | Code: {SELECTED_CODE}")

# --------------------------------------------
# API & DB Configuration
# --------------------------------------------
API_ENDPOINT = 'http://localhost:1001/ws-calculator/meterConnection/_create?'
AUTH_TOKEN = '93a9d9a5-33fc-442a-baff-bea89ccd73b3'
SEARCH_API_TOKEN = '93a9d9a5-33fc-442a-baff-bea89ccd73b3'

dbname = os.getenv("DB_NAME", "MeterQ3Data")
dbuser = os.getenv("DB_USER", "postgres")
dbpassword = os.getenv("DB_PASSWORD", "postgres")
host = os.getenv("DB_HOST", "localhost")

connection_db_ws = psycopg2.connect(
    dbname=dbname, user=dbuser, password=dbpassword, host=host
)
cur = connection_db_ws.cursor()

# --------------------------------------------
# Check if billing period already exists
# --------------------------------------------
def should_process_connection(connection_no):
    url = f"https://mseva.lgpunjab.gov.in/ws-calculator/meterConnection/_search?tenantId=pb.amritsar&connectionNos={connection_no}&offset=0"
    headers = {
        'Content-Type': 'application/json;charset=UTF-8',
        'accept': 'application/json',
    }
    payload = {
        "RequestInfo": {
            "apiId": "Rainmaker",
            "ver": ".01",
            "action": "_search",
            "did": "1",
            "key": "",
            "msgId": "20170310130900|en_IN",
            "requesterId": "",
            "authToken": SEARCH_API_TOKEN
        }
    }

    try:
        res = requests.post(url, headers=headers, json=payload, timeout=5)
        if res.status_code != 200:
            print(f"‚ö†Ô∏è API error for {connection_no}: {res.status_code}")
            return False

        data = res.json()
        readings = data.get("meterReadings", [])

        for r in readings:
            period = r.get("billingPeriod", "").replace(" ", "").strip()
            reading_date = r.get("currentReadingDate")

            # Remove spaces from both sides for comparison
            target_period = billingPeriod.replace(" ", "")

            # 1Ô∏è‚É£ Billing period check (same period or same end date)
            if period == target_period or period.endswith(target_period.split("-")[1]):
                print(f"‚ùå Already exists for {connection_no}: Billing period {period}")
                return False

            # 2Ô∏è‚É£ Current reading date check (matches our selected period's date)
            if reading_date == current_date_epoch:
                print(f"‚ùå Already exists for {connection_no}: Current reading date matches target {reading_date}")
                return False

        return True

    except Exception as e:
        print(f"üî• Exception for {connection_no}: {e}")
        return False


# --------------------------------------------
# Send meter reading and generate demand
# --------------------------------------------
def handle_meter_status(json_data, status, previous_meter_reading, current_meter_reading):
    payload = {
        "RequestInfo": {
            "apiId": "Rainmaker",
            "ver": ".01",
            "action": "",
            "did": "1",
            "key": "",
            "msgId": "20170310130900|en_IN",
            "requesterId": "",
            "authToken": AUTH_TOKEN,
            "userInfo": {
                "id": 3288460,
                "userName": "EMP-AMRITSAR-MIGRATOR",
                "name": "EMP-AMRITSAR-MIGRATOR",
                "gender": "MALE",
                "mobileNumber": "9459286077",
                "active": True,
                "type": "EMPLOYEE",
                "tenantId": "pb.amritsar",
                "roles": [
                    {"code": "WS_DOC_VERIFIER", "name": "WS Document Verifier", "tenantId": "pb.amritsar"},
                    {"code": "SW_DOC_VERIFIER", "name": "SW Document Verifier", "tenantId": "pb.amritsar"}
                ],
                "uuid": "e596bfcc-9331-4306-af2b-d1162b463263"
            }
        },
        "meterReadings": {
            "currentReadingDate": current_date_epoch,
            "currentReading": current_meter_reading,
            "billingPeriod": billingPeriod,
            "meterStatus": status,
            "connectionNo": json_data['id_no'],
            "lastReading": previous_meter_reading,
            "lastReadingDate": prev_date_epoch,
            "tenantId": "pb.amritsar",
            "generateDemand": True
        }
    }

    headers = {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ZWdvdi11c2VyLWNsaWVudDplZ292LXVzZXItc2VjcmV0',
    }

    response = requests.post(API_ENDPOINT, json=payload, headers=headers)
    now = time.strftime("%Y-%m-%d %H:%M:%S", time.localtime())
    connection_no = json_data['id_no']

    if response.status_code == 200:
        print(f"‚úÖ Success for {connection_no}")
        cur.execute("""
            UPDATE meter_billing_missing_q4
            SET response_code = '200', ismigrationdate = %s, response = %s
            WHERE id_no = %s
        """, (now, response.text, connection_no))
    else:
        print(f"‚ùå Failed for {connection_no}: {response.status_code}")
        cur.execute("""
            UPDATE meter_billing_missing_q4
            SET response_code = %s, ismigrationdate = %s, response = %s
            WHERE id_no = %s
        """, (str(response.status_code), now, response.text, connection_no))

    connection_db_ws.commit()
    print("--------------------------------------------------")

# --------------------------------------------
# Fetch connections and process
# --------------------------------------------
# cur.execute("""SELECT row_to_json(cd) FROM meter_billing_missing_q4 AS cd WHERE response IS NULL AND prev_rdg IS NOT NULL AND islocked = 'TRUE' AND isdead = 'FALSE' LIMIT 250 OFFSET 0;""")
cur.execute("""SELECT row_to_json(cd) FROM meter_billing_missing_q4 AS cd WHERE id_no in ('0107000003','0107000005','0107000009','0107000019','0107000025','0107000031','0107000038','0107000040','0107000041','0107000052','0107000054','0107000066','0107000069','0107000070','0107000072','0107000073','0107000075','0107000077','0107000081','0107000090','0107000097','0107000101','0107000102','0107000104','0107000105','0107000112','0107000115','0107000122','0107000125','0107000128','0107000131','0107000134','0107000157','0107000168','0107000169','0107000173','0107000174','0107000189','0107000199','0107000201','0107000203','0107000213','0107000221','0107000234','0107000240','0107000253','0107000292','0107000294','0107000295','0107000309','0107000310','0107000314','0107000315','0107000320','0107000327','0107000335','0107000339','0107000357','0107000365','0107000409','0107000434','0107000447','0107000448','0107000451','0107000474','0107000475','0107000476','0107000480','0107000482','0107000483','0107000484','0107000485','0107000489','0107000494','0107000496','0107000497','0107000515','0107000516','0107000521','0107000527','0107000532','0107000540','0107000543','0107000544','0107000548','0107000549','0107000553','0107000582','0107000584','0107000596','0107000601','0107000624','0107000626','0107000648','0107000662','0107000663','0107000664','0107000669','0107000785','0107000795','0107000805','0107000818','0107000832','0107000841','0107000842','0107000857','0107000859','0107000861','0107000866','0107000871','0107000911','0107000912','0107000916','0107000921','0107000924','0107000931','0107000937','0107000941','0107000943','0107000947','0107000950','0107000952','0107000961','0107000966','0107000967','0107000977','0107000986','0107000993','0107001013','0107001034','0107001035','0107001036','0107001039','0107001064','0107001082','0107001089','0107001094','0107001099','0107001116','0107001124','0107001125','0107001150','0107001167','0107001173','0107001180','0107001182','0107001195','0107001208','0107001209','0107001226','0107001238','0107001243','0107001260','0107001264','0107001274','0107001275','0107001286','0107001317','0107001318','0107001319','0107001333','0107001341','0107001343','0107001344','0107001346','0107001356','0107001357','0107001360','0107001371','0107001375','0107001376','0107001379','0107001392','0107001393','0107001408','0107001409','0107001417','0107001430','0107001432','0107001450','0107001456','0107001469','0107001474','0107001482','0107001484','0107001494','0107001496','0107001497','0107001498','0107001505','0107001510','0107001513','0107001523','0107001526','0107001532','0107001535','0107001537','0107001538','0107001544','0107001556','0107001568','0107001579','0107001586','0107001587','0107001593','0107001597','0107001623','100000','100001','100003','100006','100007','100022','100023','100026','100028','100034','100035','100038','100039','100040','100041','100042','100043','100046','1003','100431','100449','100508','100577','10064','10067','100675','10070','100704','100941','100945','100981','101050','101163','101221','101276','101324','101325','101326','101331','101333','101335','101336','101337','101338','101340','101341','101344','101345','101346','101352','101357','101462','101463','101466','1015','101507','101513','101537','10163','101648','101649','101675','101678','101679','101680','101944','101999','102003','102010','102012','102015','102132','102140','102360','102362','1024','102426','102650','102678','102730','102969','103111','103112','103143','103456','103458','103467','103502','103506','103528','103583','103632','103740','103800','103842','103846','103853','103855','103856','103941','103942','103945','103948','104031','104123','1042','104217','104218','104222','10428','10455','104568','104741','104749','10491','104963','104985','105043','105066','105071','105072','105073','105074','105075','105076','105077','10512','105180','105188','1053','105391','105402','105503','105504','105506','105513','105514','105515','105517','105518','105519','105521','105523','105524','105528','105529','105532','105535','105539','105540','105542','105551','105553','105554','105555','105557','105558','105562','105563','105564','105565','105566','105567','105569','105570','105571','105574','105575','105576','105577','105578','105579','105580','105582','105583','105585','105586','105587','105588','105589','105590','105591','105593','105594','105595','105596','105597','105598','105599','105600','105601','105603','105606','105607','105609','105611','105613','105614','105615','105616','105617','105618','105620','105621','105622','105623','105626','105630','105635','105636','105637','105639','105640','105642','105646','10568','10569','10571','105718','10572','105721','10573','105748','105752','105770','105777','105778','105779','105781','105788','105809','10581','105820','105831','105836','105842','105854','105856','105857','105860','105863','105869','105875','105881','105889','10589','105890','105898','105902','105905','105907','105917','105919','105922','105923','105975','105980','105986','106022','106036','106039','106044','106054','106055','106058','106060','106062','106063','106064','106065','106070','106078','106084','106089','106099','106101','106110','106112','106113','106119','106132','106144','106149','106150','106153','106155','106159','106167','106172','106173','106211','106212','106223','106228','106236','106246','106247','106256','106271','106289','106303','106314','106315','106316','106317','106320','106322','106323','106406','106407','106409','106414','106420','106423','106426','106429','106447','106449','106454','106458','106459','106465','10658','106581','106591','106592','106593','106595','106596','106597','106598','106600','106601','106603','106605','106606','10661','106610','106611','106612','106613','106615','106616','106619','10662','106620','106622','106625','106626','106629','10663','106630','106631','106633','106635','106637','106639','106640','106641','106642','106643','106645','106646','106647','106648','106649','10665','106650','106651','106652','106653','106654','106656','106657','106658','106659','106660','106661','106662','106663','106664','106665','10668','106705','106725','106726','106735','106738','106743','106744','106745','106747','106752','106754','106755','106909','106988','107014','107017','107030','107071','107072','107092','107124','107163','107165','107167','107217','10735','10741','10743','107439','10744','107442','10746','1076','107640','107679','1077','107733','107774','107776','107924','108030','108031','108043','108073','108174','108281','108304','108336','108337','108400','108425','108466','108469','108470','108472','108477','108489','108498','108607','108644','10872','108764','108765','108767','10877','1088','108934','108994','10901','109067','109069','10907','109078','10908','109093','10922','10923','10933','109423','10943','109448','10960','10965','10975','109755','109764','109841','10987','10993','10997','110004','11003','110038','11004','110040','110041','110062','11007','110108','11015','11019','110190','11026','11027','110298','11032','11036','11037','11038','11039','11040','11042','110421','11043','110433','11047','11048','110488','11050','11058','11061','110613','11062','110621','11064','11065','11066','11068','11069','11070','11071','11072','11073','11075','11076','11078','11079','11082','110850','11094','11095','11096','11097','11103','11104','11106','11108','111101','111130','11114','111141','11115','11116','11117','11118','111239','11124','11125','11126','11127','11128','11129','11133','11146','111615','11211','112928','112936','112937','113102','113155','113216','113373','1134','11341','11342','11344','11349','11351','113935','113936','113938','113972','1140','114247','114373','114467','114470','114566','114607','114643','114687','114826','114845','114846','114855','114858','114860','114864','114865','114867','114870','114871','114873','114874','114875','114879','114880','114883','114884','114885','114886','114888','114889','114890','114891','114892','114893','114897','114900','114903','115000','115184','1152','115223','115226','115313','115367','1154','115519','115529','115534','115690','115703','115736','115752','116192','1162','116220','116264','116360','116380','1164','116419','116464','116465','1165','116584','11660','11661','116697','116699','116703','116722','116990','117013','117056','117248','117252','1173','117342','117434','117438','117595','1176','117669','117850','118','118088','1181','118201','118277','118380','118404','118489','1185','1186','11880','119009','11931','11954','119642','11969','12013','12090','121','1210','12100','1212','1213','1214','1215','121617','121639','12177','1219','122','1220','122087','1223','12243','12285','12287','123107','123191','12329','12343','123635','12379','12382','1241','124325','124336','124344','124345','124443','124444','124461','124464','124487','12449','124523','124757','124758','124761','124769','124770','12478','124794','124859','124900','12492','124929','12524','125281','125329','12556','12562','12576','12581','12584','1261','126101','12611','126280','126307','126323','12636','126370','126374','126415','126454','126455','126456','126597','1266','126701','126717','126718','12672','126753','126788','127089','1271','127104','127162','127168','127271','127298','127331','127335','127481','127999','12803','12805','12811','1283','12857','12860','1287','129123','129125','129126','129129','129140','129146','129152','129174','129370','129377','129378','129380','129388','129390','129403','129418','129468','129471','129473','129481','129483','129567','129571','129577','129578','129593','129609','129621','129646','129757','129761','129773','129776','129782','129791','129813','129869','130191','130195','130208','130346','130352','130467','130472','130511','130516','130579','130627','130637','130641','130691','130698','130703','130704','130716','130717','130762','130784','130811','130816','130817','130857','130915','130992','130996','131033','131054','131059','131063','131071','131191','131210','131320','131321','131396','131492','131547','131554','131633','131637','131674','131704','131708','131757','13179','131966','132048','132076','132153','1322','1324','1325','13250','13252','132575','132576','132578','13259','132596','13261','132666','132667','132693','132698','1327','132753','132800','132805','132867','133150','133173','133174','133182','133185','133187','133649','133869','133890','133998','1340','134004','134029','134142','134215','134283','134365','134464','134541','134603','134604','134676','134811','135086','135106','13590','136057','136085','13612','136120','136261','13631','13632','13636','13648','136487','1365','136655','136658','136675','136676','136800','136960','136978','13713','13718','137191','137192','1372','137261','137337','13740','13744','13747','13753','13778','1378','13782','138079','138182','138194','138222','138239','138476','13854','138555','138556','138608','138612','138641','138653','138707','138757','138795','138796','138843','13896','13905','139138','139172','13923','13930','139301','139408','139509','139567','139568','139633','139648','139689','139743','139772','139791','139977','139978','14','140075','140098','140101','140104','140195','140361','14046','140477','140629','140636','140654','140655','140656','140658','140661','140749','140753','140782','140788','140795','140797','140800','140986','1411','141155','141322','141847','141848','14193','14199','142012','142029','142036','142056','142061','142064','142072','14222','14250','14268','142690','14277','142777','14278','14281','142817','142891','14296','142970','14299','143','14307','14308','14314','14315','143192','143216','143223','14330','143308','143309','14331','143310','143317','14332','14336','14337','14340','14348','143483','143495','143496','143497','143501','143502','143507','143515','143520','143526','143546','143550','143614','143635','14364','14370','14372','14377','14378','14381','14389','143930','14394','143945','143961','14400','14404','14407','14416','14426','14432','14434','14442','14460','14466','14467','14469','14471','14473','14486','14500','14502','14503','14507','145206','145293','145304','145314','145340','14535','14543','14544','14545','14547','14550','14552','145678','14585','14589','14595','14603','14614','146382','146432','14645','14648','147154','147285','147326','14733','147450','147567','147890','14794','148012','14804','14805','148126','148201','14823','14824','148303','14837','148376','14838','148404','14842','14843','148448','14849','1485','14856','14857','14865','14871','14876','14885','14900','149042','14905','149093','14913','149130','14920','14925','14928','14939','149406','149412','14943','149461','14949','149520','149532','149544','149554','149565','14959','14960','14962','14963','149640','149647','14965','149653','14967','14973','14974','14978','14982','14984','149873','14989','14993','14995','14997','15005','15011','15020','150206','150266','150273','15028','15033','15035','15055','15066','150930','150959','150992','150998','151','151134','151185','151186','15127','15128','151309','151411','15144','151518','15155','15157','151574','151580','151587','151604','15161','15172','151742','15175','151803','15188','152','15202','15205','15208','15213','15214','15215','15216','15238','15239','15246','15250','15258','15265','152659','152676','152774','152800','152805','152813','152815','15320','15321','15328','15345','15376','153834','15384','154155','154168','154254','154256','154314','154355','15439','15485','15492','154986','15502','155031','155145','155156','15529','15538','15546','15547','155809','156056','15620','156484','156728','156758','156759','156786','157278','157336','157448','15750','157573','157591','157665','157673','157767','157786','157791','15825','15839','15840','15846','15857','158624','15865','15866','15867','15868','158695','15871','15873','15878','158847','15893','15911','15914','159145','159265','159269','159271','159272','159273','15929','159319','159324','15933','159342','15937','15938','15940','15947','15955','15971','15979','15981','15988','159931','15994','15997','15998','15999','16','16000','16001','16010','160140','16029','160307','160325','16033','16035','16036','16039','16043','16046','160610','160631','160636','160638','160641','160642','160653','160690','160720','160864','160875','16089','16094','161','161090','161122','161266','161472','161687','161783','161878','161924','161968','161979','162006','162020','162103','162207','162256','162339','16237','16240','162605','162644','16274','163106','16327','163389','163637','163838','164250','164255','16489','16543','165709','16571','165726','165760','165762','16581','165838','16594','16595','16607','16611','16613','16618','166191','16641','16643','16644','16650','16653','166531','16654','16657','16659','166667','16670','16677','1668','16680','167045','167173','1674','167471','167591','167594','168162','1685','168540','168748','16884','168978','16927','169305','169729','169758','169928','169972','170096','170152','170430','170576','170611','170672','170673','1707','170722','171083','171084','171117','171205','17124','1713','171424','171427','171433','171721','171757','17180','171838','171848','17228','172373','172375','17238','172393','172409','17241','172411','172412','172437','17244','17248','172569','172616','17264','17267','17268','172692','1727','172740','172874','172969','173023','173033','17309','17316','173165','173166','17318','17320','173215','173226','173241','17327','173272','1733','17330','173359','173375','17344','17345','173470','173512','173518','17354','17355','173600','1741','174127','174130','1742','17424','174247','17427','17428','174282','174291','17430','17434','174389','17441','174446','174466','17450','17455','174607','174703','1748','174820','174842','17485','17489','1749','17491','17505','175123','17521','175210','17534','17544','17548','17549','17554','175683','175700','176001','176026','176066','176113','176206','176376','176391','176412','176508','176608','176705','176774','176876','176915','176988','177051','177056','177220','17724','177246','177303','177304','177313','17732','17734','17736','177378','177418','177452','17747','177502','17753','177535','17754','17755','17756','177571','177693','177695','17772','177762','17778','177801','177812','177829','177836','177873','177874','178025','17823','17825','17827','17829','178293','178320','17834','178495','17861','178614','178621','17865','17866','178662','17867','17869','17871','178719','178745','178901','178931','178948','17898','178981','17899','17900','179071','17912','179172','17920','179271','17931','179316','179362','179365','17939','17940','17943','179455','179526','179578','179602','179649','179700','179765','179774','18011','18012','18023','180259','180275','180285','180321','180325','180328','180372','180402','180407','180435','180447','180495','18060','180634','180687','180716','180792','180865','18088','180892','180893','180959','181021','181043','181093','181173','18119','181318','181485','181524','181528','181586','181592','181595','181742','1818','181851','181852','1819','181904','181985','181986','1820','182004','182047','182053','182083','182084','182085','182130','182131','182197','1822','182248','182284','182348','182359','182388','1824','182405','182472','1825','182575','182678','182683','182685','1827','182721','182757','182793','1828','182834','183127','1832','183655','1837','183701','183827','183883','183966','183998','184','1840','184017','184024','184043','184058','1841','184265','184317','1844','18456','184565','1847','184822','184887','184889','184924','185041','185043','185055','185061','185092','185133','185164','185174','185207','185290','185301','185302','185357','185375','185461','185494','185509','185541','185563','185670','185688','185698','185709','185713','185740','185765','185805','185849','185905','185928','185935','185950','185953','185967','186008','186097','186178','186311','186487','1867','186837','1871','18719','18733','187376','18745','18750','18771','18778','18801','18806','188097','18827','18849','188512','188534','189269','189492','189536','189663','189716','189718','189719','189761','189878','189965','189998','1900','190182','1903','190469','1908','1909','191176','191246','191320','191407','191416','191467','191717','191726','191756','191767','19184','191859','191879','19189','191910','192','192053','192054','192057','192062','1921','192127','192172','192188','1922','192228','192234','19228','192312','192322','192327','192328','192331','192348','192414','192420','19243','19244','192478','192492','19252','192560','19258','192647','192699','192703','192759','192760','1928','192827','192848','192854','192868','192923','19294','19296','193','193080','193124','193128','193151','193178','193184','193192','193207','193208','193229','193242','193265','193273','193274','193285','193287','193310','193376','193380','193406','193417','193475','193555','1936','193614','193655','193682','193712','193753','1938','193826','193835','193871','193883','193939','193954','193997','194004','194089','194124','194127','194189','194193','194204','194222','194245','194260','194263','194269','194395','194445','194550','194599','194702','194703','194726','1948','194879','194946','195011','195060','195134','195377','195398','1954','195465','195475','195560','195576','195735','195800','195828','195941','19637','196489','196541','19657','196650','196655','19670','196713','196746','196747','196759','196761','196839','196864','196887','196888','196898','196912','196913','196938','196983','197022','197085','197161','197186','197360','197362','197448','197461','197786','197811','197824','198146','198149','1982','198281','198500','198507','198526','198597','198636','19867','198996','199019','199051','199070','199145','199151','199167','199192','199193','199209','199298','199328','199378','199388','199392','199422','199441','199545','199610','199620','199659','200861','20088','200914','200975','200981','20126','20145','20204','202254','202310','202459','20259','203541','203578','203689','20372','20373','20374','204801','204874','204917','204919','204934','204940','204951','204971','205091','205112','205117','205158','205308','205319','205378','205393','205394','206709','206789','206883','206898','206901','206902','206930','206932','206963','206975','206990','207015','207021','207043','207049','207056','207064','207065','207066','207076','207085','207088','207092','207109','207117','207123','2072','20720','207255','207390','207393','2077','20783','2083','208395','208401','20892','20893','20913','2097','20985','20988','21','21005','21033','210444','21081','21182','21198','212463','212468','21289','21297','21299','213471','21398','21449','21455','21463','21469','21591','21665','216722','2178','21809','218352','2184','218596','21879','219013','219032','219075','219088','219157','219159','219178','21922','219243','21934','21935','21943','219606','219666','219669','22067','220771','220801','220808','220902','220932','220973','220974','220987','221044','221048','221049','221050','221087','22120','22123','221368','221369','221491','221539','221557','221558','22227','2229','22542','22567','2280','2290','22942','2295','2298','2299','23','2307','2314','2317','2318','23232','2333','2335','2336','2339','2341','23432','23450','2346','23467','23468','2347','23478','23483','23528','23562','23586','23624','2364','23668','23677','23686','23693','23728','23743','23747','23755','23765','23768','23776','2382','2385','23890','23964','2397','2401','24061','24155','24204','2421','24397','24404','24466','24467','24517','246','24607','2467','2469','24765','24775','2486','24879','24883','24891','24894','24906','25086','25087','25096','25107','25108','25121','25136','25156','25175','25183','25205','25213','25221','25246','25314','25317','25318','2539','25408','25409','25410','25411','25412','25417','25427','25429','25446','25450','25457','25472','25491','25496','25497','25498','25501','25505','25506','25508','25509','25510','25511','25538','25551','25557','25562','25563','25567','25621','25624','25869','26015','26084','26085','26092','26104','26111','26112','26115','26116','26131','26201','26261','26264','26285','26288','26294','26299','26300','26301','26303','26304','26381','26449','26451','26457','26481','26482','26490','26491','26530','26543','26571','26573','26718','26781','268','26844','26903','27021','27136','27137','27155','27158','27224','27266','27399','27420','27475','27503','27629','27631','27633','27637','27641','27646','27653','27654','27656','27658','27671','27680','27703','27711','27751','27768','27789','27799','27808','27841','27843','27849','27853','27854','27866','27877','27887','27909','27911','27913','27918','27921','27939','27948','27952','27953','27964','27983','27989','27993','27997','28005','28018','28020','28026','28036','28038','28039','28042','28053','28061','28091','28092','28093','28105','28114','28120','28123','28126','28133','28139','28143','28153','28164','28180','28188','28191','28202','28210','28215','28217','28218','28219','28223','28228','28229','28235','28242','28245','28247','28261','28269','28270','28274','28281','28282','28289','28308','28309','28354','28359','28360','28364','28370','28380','28385','28522','28530','28550','28553','28559','28644','28656','28678','28718','28738','28751','28754','28758','28764','28765','28766','28781','28789','28796','2880','28857','28861','2887','28872','2888','28988','29012','29119','29130','29162','29178','29181','29187','29189','29217','29218','29219','29222','29238','29413','29415','29432','29442','29479','29499','29514','29515','29516','2953','29577','29599','29615','29617','29623','29643','29704','29706','29708','29728','29730','29745','29746','29758','29760','29813','29814','29816','29822','29825','29831','29833','29841','29849','29852','29866','29885','29890','29892','29908','29910','29916','29919','29926','29927','29934','29943','29944','29945','29997','29998','29999','30117','30127','30141','30144','30165','30166','30211','30286','3031','30323','3034','30358','30398','30713','30715','30716','30718','30727','30740','30750','30757','30758','30770','30773','30774','30778','30781','30784','30786','30803','30851','30888','30922','30937','30953','30967','30986','30991','31005','31045','31073','312','31219','31221','31459','31481','31521','31522','31523','31529','319','322','32711','32713','32755','32769','32786','32790','32840','32868','32912','32949','32957','32958','32960','32961','32963','32964','32966','32968','32969','32973','32981','32983','330','33019','33020','33026','33027','33028','33029','33030','33038','33042','33046','33049','33050','33053','33069','33076','33080','33087','33088','33091','33106','33107','33187','33223','33245','3333','33347','33419','335','33516','33529','33570','33619','33631','33690','33720','33746','33791','3380','3389','33904','33907','3398','33984','33999','34005','34014','34058','34104','34140','34146','34152','34169','3424','34287','34309','34312','34313','34314','34325','34327','34329','34348','34361','34370','34375','34384','34388','34430','34432','34433','34436','34437','34441','34443','34449','34452','34453','34454','34455','34456','34458','34464','34466','34469','34482','34483','34486','34488','34492','34501','34521','34526','34534','34538','34552','34558','34560','34565','34578','34584','34591','34595','34597','34601','34612','34622','34634','34727','34773','34778','34788','34800','34802','34804','34808','34810','34811','34813','34819','34823','34825','34827','34838','34841','34847','34849','3485','34857','34860','34872','34878','34882','34884','35046','35074','35079','35084','35143','35151','35188','352','35248','35278','35285','3532','35363','35366','35367','35370','35374','35380','35382','35383','35384','354','35413','35426','35427','35430','35438','35440','35441','35702','35740','35798','35799','35815','35843','35889','3592','3627','3678','368','37','3703','37306','37337','37370','3750','3757','3765','3767','37780','37920','37921','380','3802','3846','385','38654','3871','38710','38767','39013','39070','39073','39085','39438','395','39629','3966','3967','39680','397','3975','39762','39778','398','3981','399','39939','39999','4002','40050','4006','4014','40284','4044','40448','4045','4053','40623','4075','4076','40799','4084','4085','4089','4094','4095','4096','41039','41324','41406','41413','41445','41494','41571','41573','41577','4158','4159','4166','41711','41743','41846','41874','42053','4215','4227','4236','4246','4249','4250','4251','4254','4260','4261','4266','4267','4269','4270','4272','42737','42758','4282','4285','4286','4287','4288','4289','4295','4296','42961','42973','4299','43651','43671','43673','43674','43676','43738','4378','43874','439','440','4409','441','44165','4417','44177','44187','4420','4423','4424','4425','44268','44418','44512','44517','44563','4467','44702','4474','4476','44854','4489','4494','45048','45182','45190','45197','45205','45207','45247','45316','45337','45378','45380','45385','45414','45417','4545','45453','45454','45456','45466','4550','4552','4598','4600','4601','4604','4607','46075','461','4610','462','46409','46577','46761','46791','46798','469','46940','46969','47001','471','47152','47216','473','474','47484','47559','47598','47661','478','47833','48022','48029','48167','482','48219','48479','48494','48574','4870','48733','48780','48802','48805','48807','48809','48813','49057','491','492','4922','495','4952','4953','4970','49778','499','500','50011','501','5024','5026','507','50777','50787','50788','50789','50790','50791','50802','50804','50805','50816','50821','50937','50987','50996','51032','51037','51051','51062','51140','51203','5127','5128','513','5139','51456','51457','51463','51464','51470','51488','51518','51635','51857','51901','52','52042','52168','52176','52178','52179','52335','52528','52672','52823','52834','52837','52905','52906','52919','5292','52922','52925','52926','52927','52928','52929','52931','52934','52939','5297','52978','5298','52987','53331','53510','53665','53670','53671','53674','53911','5392','53994','54141','54155','5423','54355','5440','54476','54656','54723','54757','54789','54806','54816','54817','54900','54930','55','55028','55031','55134','55135','55149','5523','55365','55390','55418','55422','55482','55490','55521','55532','55570','55602','55611','55618','55629','55664','55666','55669','55673','55674','55696','557','55709','55724','55725','55731','55732','55736','55746','55748','55750','55751','55752','55754','55760','55767','55769','55771','55773','55788','55801','55869','55870','55871','55872','55873','55887','55922','55928','55929','55930','55931','55933','55934','55936','55937','55938','55939','55941','55942','55944','55945','55946','55947','55948','55955','55957','55960','55961','55963','55965','55966','55971','55975','55976','55979','55980','55982','55983','55984','55985','55986','55987','55990','55992','55996','55997','55998','56','56001','56002','56004','56006','56007','56008','56011','56012','56013','56014','56022','56023','56025','56029','56033','56034','56059','56110','56111','56148','56179','56219','56238','56286','56360','56366','56372','56373','56375','56376','56378','56379','56380','56462','56464','56499','56508','56519','56537','56570','56572','56573','56578','56754','56974','56998','57082','57109','57113','57121','57164','57194','57239','57240','57259','57262','57300','57310','57311','57317','57326','57328','57331','57349','57351','574','57417','57517','57538','57553','57612','57613','57626','57644','57648','57649','57652','57653','57668','57673','57674','57677','57678','57680','57691','57692','57703','57718','57727','57755','57798','57803','57805','57808','57841','57850','57895','57899','57900','57909','57911','57958','57973','57981','58','58009','58014','58018','58021','58033','58041','58045','58061','58093','58094','58095','58104','58108','58110','58111','58138','58143','58147','58153','58167','58169','58190','58191','58192','58194','58201','58207','58210','58213','58224','58225','58227','58233','58246','58251','58252','58268','58318','58339','58340','585','5853','58533','58541','58542','58595','58628','58630','58634','58656','58657','58680','58712','5878','58786','588','58880','58919','58925','58926','5894','58958','58963','5899','58991','59061','59074','59105','59107','59108','59126','59136','59153','59170','59171','59173','59174','592','59202','59220','59221','59224','59225','59226','59228','5923','59304','59360','59434','59448','59492','59584','59619','59626','59644','59654','59659','59663','59671','59673','59678','59680','59682','59685','59686','59690','59698','59701','59763','5979','5983','59871','59875','59908','59909','59911','59928','59963','59977','60031','60167','60263','604','606','60608','60614','60625','60628','60643','6065','60771','60791','60793','60807','60809','60810','6084','609','60923','60925','60955','60956','60981','60984','60986','60992','60995','61','61006','61018','61019','61031','61034','61038','61055','61058','61060','61061','61064','61068','61069','61074','61086','61098','61099','61101','61102','61133','61149','612','61206','61248','6132','614','61486','61488','6156','61562','61582','6161','61652','6167','617','61708','61745','61746','61763','61767','61831','6185','61864','61891','61893','61908','6192','61924','61925','61927','61929','61931','61957','61958','61959','6196','61960','61966','6200','6205','6208','6209','6236','6250','62612','62614','62616','62636','62649','62657','62675','62680','62687','62692','62734','62735','62757','62758','62818','62856','62875','62892','62893','62898','62910','62911','62915','62917','62921','62922','62937','6294','62943','62952','62971','62981','62983','62998','63001','63007','63052','63062','63063','63067','63070','63072','63077','63078','63084','63085','63139','63143','63149','63238','63239','63247','63270','63283','63300','63313','63317','63318','63372','63375','63380','63392','63418','63432','63441','63444','63445','63499','6354','63577','63606','637','6375','6377','6379','6384','63849','63855','6402','6403','6409','6410','6414','6444','6445','645','64525','64591','64662','64676','64679','64731','64732','64788','64850','64877','6490','6491','64932','64955','6498','64981','6503','65044','651','65111','65172','65270','653','65331','65333','65366','65390','654','65457','65470','65471','65473','65482','656','65694','657','65731','65796','6584','65906','65908','65912','65913','65947','66015','66052','66055','66064','661','66153','66188','66288','66537','66554','66571','66714','66766','66830','66875','66898','669','66910','66929','66930','66973','66975','67006','67034','67035','67040','67042','67047','67052','67056','67058','67062','67067','67077','67078','67101','67105','67108','67129','67170','67183','67185','67199','67213','67218','67369','67373','67510','67516','67540','67562','67569','67606','67612','67621','67622','67660','67663','67665','67667','67691','6778','67782','6779','68096','68099','68101','68120','68152','68154','68178','68179','68182','68297','68358','6836','68366','68374','68380','68426','68427','68461','68479','68733','68786','68787','68795','68797','68800','68821','68830','6884','6889','6893','693','69394','69433','69437','69440','69452','69463','69466','6956','69563','69577','6958','6959','696','6961','6964','69647','6967','69675','6972','69751','69766','69774','69777','69887','69925','69970','69973','69976','69987','69995','69998','70041','70107','70186','70189','70198','70204','70206','70207','70209','70214','70221','70224','70231','70232','70235','70244','70247','70336','70337','70338','70339','70363','70367','70368','70369','7037','70371','70373','70375','70376','70377','70378','70379','7038','70384','70389','70396','70397','70398','70403','70405','70406','70424','70425','7058','7065','70656','70657','70660','70667','70682','70683','70697','70702','70712','70715','70718','70719','70738','7074','70806','70807','70817','70829','70838','70846','70863','70877','70886','7089','70901','70906','70912','70924','70928','70933','70938','70955','70964','70970','70975','70981','710','7101','7102','71021','71189','7123','7124','71244','71253','71258','71269','7128','71318','71319','7132','71322','71330','71331','7134','71340','71341','71342','71346','71347','71348','71382','71383','71387','71390','71393','71399','71424','71445','71462','71473','71475','7148','71484','715','71522','71533','71540','71549','71568','71572','71578','716','71632','71633','71640','71643','71719','71724','71769','71772','71773','71776','71777','718','71817','71818','71822','71854','71862','71893','719','71901','71935','71942','71943','71944','71954','71960','71966','71973','71974','71984','72','720','72029','72093','721','72116','722','72231','72240','72243','72257','72325','72329','72337','72451','72499','72510','72562','72564','72565','72852','72934','73','73050','73188','7326','733','734','73406','73410','73425','73426','73450','73457','735','73522','73542','73543','73551','73552','73560','73567','73683','73705','73736','73746','73749','73751','73755','73756','73788','73792','738','73809','73818','73819','73820','73832','73833','73834','73835','73844','74','740','741','7413','74164','74166','74170','74250','74259','74269','74324','74330','74334','74347','74349','74350','74353','74394','74416','74417','74457','74462','74463','74490','74503','74505','74506','74526','74529','7453','74533','74551','74581','74589','74591','74617','74619','74642','7466','7470','74798','74799','74801','74802','74803','74817','74825','74827','74829','74830','74831','74833','74840','74845','74848','74849','74850','74864','74867','74868','74869','74870','74871','74878','74885','74887','74890','74891','7492','74938','74946','7495','74952','74963','74972','74977','74993','74994','74998','75','75001','75004','75005','75067','75073','75091','75099','75108','75183','75184','75186','752','75216','75264','7527','753','75397','754','75418','75428','75444','75492','75530','75564','75597','75598','75671','75716','75717','75763','75764','7580','75845','75880','75885','75886','7596','75965','7597','7600','76054','7610','76356','76603','76690','7672','7677','76786','76833','76890','7690','7692','7695','76951','7696','7697','76972','7698','7699','7700','7705','77103','7713','77158','77160','77162','77163','77167','77181','77182','77183','77187','77189','77197','77207','7722','7726','77346','77428','7755','7779','77809','77848','77906','780','7800','7801','7806','78107','7811','7815','78270','78302','78350','78555','7876','7878','78920','78926','79','79002','79061','79084','79125','79265','79330','79347','795','79535','79558','79565','79608','79644','79661','79662','797','79929','79934','80','8008','80115','80430','80462','80496','80500','80622','80670','80725','80922','81','81087','8117','81502','825','8253','827','828','83002','83018','83125','83126','83129','83181','83197','83582','8370','8372','8373','8380','84063','8408','8412','84235','84275','84276','843','8438','8439','84401','84434','84439','84520','8453','84625','84652','84665','847','84863','84923','84952','84962','84970','84971','84990','85012','85018','85030','85170','85172','85183','85187','85197','85214','85223','85224','85226','85227','85228','85229','85238','85239','85248','85249','85250','85256','85259','85261','85262','85263','85265','85269','85270','85273','85277','85285','85286','85465','85480','85617','85622','85628','85629','85631','85633','85634','85638','85670','85671','85691','85701','85703','85716','85731','85732','85744','85756','85757','85767','85769','85774','85789','85790','85808','85809','85831','85832','85837','86343','8636','86432','86496','86589','86590','86591','86593','86631','8664','86931','8701','87055','87106','87111','87134','8751','87513','87520','87550','87809','87816','87885','87972','88094','88256','88257','88423','88458','88460','88467','88468','88475','88476','88495','88526','88571','88624','88848','88994','88995','8905','8906','89095','89170','8934','8943','8965','89706','89708','89734','8974','89752','89766','89767','89768','89771','89774','89802','89822','8984','90','90043','9016','90248','90285','9043','9069','90743','9079','90974','91197','91208','91213','91220','91221','91230','91231','91232','91233','91238','91244','91245','91246','91315','91433','91442','91444','91620','91621','91622','91623','91624','91625','91626','91627','91628','9221','9225','9228','9230','9237','9239','9241','9242','9246','9259','93','93316','9332','93322','93324','93325','93326','93328','93329','93330','93332','93333','93334','93336','93337','93338','93339','93347','93348','93350','93351','93354','93355','93357','93358','93359','93380','93392','93490','93499','93501','93507','93511','93547','93550','93551','93556','93557','93558','93559','93686','93690','93785','93794','93799','93802','93853','93855','9387','9390','93917','93919','93920','93921','93927','93934','93951','93959','93967','93969','93984','93988','9400','94011','94018','94020','94021','94022','94048','94049','94057','94058','94124','94214','94233','94276','94278','94280','94283','94514','94592','94614','9478','94879','94881','94882','9489','95269','95315','95321','95429','95457','956','95659','95870','95951','95963','95983','95993','96005','96006','96009','96165','96267','96273','96278','96280','96308','96309','96320','96324','96433','96499','96528','96584','96637','96639','96644','96648','97013','97015','97120','97168','97208','97286','97287','97291','97295','97306','97374','97387','97405','97407','97413','97427','97661','97673','97675','97679','97681','97682','97684','97687','97714','97719','97722','97729','97731','97744','97750','97770','97771','97775','97777','97779','97783','97787','97790','97792','97793','97795','97796','97797','97805','97808','97812','97815','97816','97823','97826','97827','97828','97829','97832','97833','97834','97838','97840','97841','97844','97845','97849','97851','97852','97854','97855','97856','97858','97863','97867','97873','97874','97878','97880','97882','97883','97884','97887','97889','97890','97891','97892','97895','97896','97897','97902','97908','97910','97911','97912','97913','97921','97957','98005','98011','98038','98043','98044','98050','98073','98079','98126','98127','98174','98242','98245','98298','983','9831','98312','98313','98324','98327','98430','98443','98485','98489','98503','98619','98623','98644','98648','98649','98672','98673','98674','98676','98680','98691','98720','98730','98745','98747','98762','98763','98877','98955','99','99005','99060','99076','99080','99088','99104','99110','99111','99257','99261','99262','99305','99306','9933','9934','99510','99608','99630','99640','99642','99781','99785','99810','99830','99845','9992','99920','9993','99940','99950','99952','99955','99957','99960','99961','99963','99965','99966','99967','99977','99980','99982','99983','99988','99989','99990','99991','99992','99994','99996','99997','99998') AND response_code is null;""")


data_row = cur.fetchmany(6000)

for row in data_row:
    json_data = row[0]
    connection_no = json_data['id_no']
    print(f"üîÑ Checking: {connection_no}")

    if not should_process_connection(connection_no):
        now = time.strftime("%Y-%m-%d %H:%M:%S", time.localtime())
        cur.execute("""
            UPDATE meter_billing_missing_q4
            SET response_code = '400', ismigrationdate = %s, response = %s
            WHERE id_no = %s
        """, (now, 'Duplicate billing period exists', connection_no))
        connection_db_ws.commit()
        continue

        # Determine status and call handler
    if json_data["isdead"] in ["True", "TRUE"]:
        handle_meter_status(json_data, "Breakdown", json_data.get("prev_rdg"), json_data.get("prev_rdg"))
    elif json_data["islocked"] in ["True", "TRUE"]:
        handle_meter_status(json_data, "Locked", json_data.get("prev_rdg"), json_data.get("prev_rdg"))
    elif json_data["prev_rdg"] == "N":
        handle_meter_status(json_data, "No-meter", 0, 0)
    elif json_data["islocked"] == "FALSE" and json_data["isdead"] == "FALSE":
        handle_meter_status(json_data, "Working", json_data.get("prev_rdg"), json_data.get("curr_rdg"))

# --------------------------------------------
# Cleanup
# --------------------------------------------
cur.close()
connection_db_ws.close()
print("‚úÖ Billing script completed.")
